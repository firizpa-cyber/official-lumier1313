<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANT-TV Premium</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/player-modern.css">
    <link rel="stylesheet" href="assets/css/antigravity-theme.css">
    <style>
        :root {
            --yt-red: #f00;
            --yt-bg: #0f0f0f;
            --yt-sidebar: #0f0f0f;
            --yt-card-bg: #1e1e1e;
            --yt-text: #fff;
            --yt-text-dim: #aaa;
        }

        body {
            margin: 0;
            background: var(--yt-bg);
            color: var(--yt-text);
            font-family: "Roboto", "Inter", Arial, sans-serif;
            overflow-x: hidden;
            display: flex;
            height: 100vh;
        }

        /* ОСНОВНОЙ ПЛЕЕР (СЛЕВА) */
        .main-content {
            flex: 1;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        #videoPlayerContainer {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .video-info {
            padding: 10px 0;
        }

        .video-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .video-meta {
            color: var(--yt-text-dim);
            font-size: 14px;
            display: flex;
            gap: 15px;
        }

        /* САЙДБАР (СПРАВА) */
        .sidebar {
            width: 400px;
            background: var(--yt-sidebar);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            padding: 12px;
            gap: 12px;
            height: 100vh;
        }

        /* ВКЛАДКИ */
        .yt-tabs {
            display: flex;
            gap: 8px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            overflow-x: auto;
            scrollbar-width: none;
        }

        .yt-tabs::-webkit-scrollbar {
            display: none;
        }

        .yt-tab {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .yt-tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .yt-tab.active {
            background: white;
            color: black;
        }

        /* СПИСОК КАРТОЧЕК */
        .yt-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
        }

        .yt-list::-webkit-scrollbar {
            width: 6px;
        }

        .yt-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .yt-card {
            display: flex;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 8px;
        }

        .yt-card:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .yt-card.active {
            background: rgba(255, 255, 255, 0.1);
        }

        .yt-thumb {
            width: 168px;
            height: 94px;
            border-radius: 8px;
            object-fit: cover;
            background: #222;
        }

        .yt-card-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .yt-card-title {
            font-size: 14px;
            font-weight: 500;
            line-height: 1.2;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .yt-card-meta {
            font-size: 12px;
            color: var(--yt-text-dim);
        }

        /* СПЛЭШ ЭКРАН */
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            transition: opacity 0.5s;
        }

        #splash img {
            max-width: 300px;
        }

        /* РЕКЛАМА */
        #ad-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 100;
            display: none;
            color: white;
            align-items: center;
            justify-content: center;
        }

        .ad-timer {
            position: absolute;
            bottom: 60px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: 700;
        }
    </style>
</head>

<body>

    <div id="splash">
        <h1 style="color:white; font-size: 40px;">ANT-TV</h1>
        <div class="player-spinner active"></div>
        <p style="color:#aaa;">Загрузка контента...</p>
    </div>

    <div class="main-content">
        <div id="videoPlayerContainer">
            <video id="mainVideo"></video>
            <div id="ad-overlay">
                <video id="adVideo" style="width:100%; height:100%;"></video>
                <div class="ad-timer">Реклама: <span id="ad-time">5</span> сек.</div>
            </div>
        </div>

        <div class="video-info">
            <div class="video-title" id="player-title">Выберите видео</div>
            <div class="video-meta">
                <span id="player-views">0 просмотров</span>
                <span id="player-date">...</span>
            </div>
            <div style="margin-top: 15px; color: #ddd; font-size: 14px; line-height: 1.5;" id="player-desc">
                Потяните вниз для загрузки описания...
            </div>
        </div>

        <!--Actors Section-->
        <div id="actors-section" style="margin-top: 20px; display:none;">
            <h3 style="font-size: 18px; margin-bottom: 15px;">Актёры</h3>
            <div id="actors-list" style="display:flex; gap:15px; overflow-x:auto; padding-bottom:10px;">
                <!-- Actors will be here -->
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="yt-tabs">
            <button class="yt-tab active" onclick="switchTab('collections')">Фильмы</button>
            <button class="yt-tab" onclick="switchTab('series')">Сериалы</button>
            <button class="yt-tab" onclick="switchTab('channels')">ТВ Каналы</button>
            <button class="yt-tab" onclick="switchTab('categories')">Категории</button>
        </div>

        <div class="yt-list" id="sidebar-list">
            <!-- Items will be rendered here -->
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="assets/js/player-core.js"></script>
    <script src="modules/ui/player-ui.js"></script>

    <script>
        let currentTab = 'collections';
        let dataStore = {
            collections: [],
            series: [],
            channels: [],
            categories: [],
            ads: [],
            splash: []
        };
        let player, ui;

        window.onload = async () => {
            // Инициализация плеера
            player = new ProVideoPlayer({
                videoElement: 'mainVideo',
                container: 'videoPlayerContainer',
                autoplay: false
            });
            ui = new PlayerUI(player);

            // Загрузка данных
            await loadAllData();

            // Скрыть сплэш
            const splash = document.getElementById('splash');
            splash.style.opacity = '0';
            setTimeout(() => splash.style.display = 'none', 500);

            // Рендер
            renderSidebar();
        };

        async function loadAllData() {
            try {
                // Fetch from our new ant-api.php
                const response = await fetch('ant-api.php?action=all');
                const result = await response.json();

                if (result) {
                    dataStore.collections = result.collections || [];
                    dataStore.series = result.series || [];
                    dataStore.categories = result.categories || [];
                    dataStore.ads = result.ads || [];
                    dataStore.splash = result.splash || [];
                }

                // Load old channels api for now as fallback if needed
                const channelsRes = await fetch('channels-api.php');
                dataStore.channels = await channelsRes.json();

            } catch (e) {
                console.error('Ошибка загрузки данных:', e);
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.yt-tab').forEach(b => {
                b.classList.toggle('active', b.innerText.toLowerCase().includes(tab.substring(0, 3)));
            });
            renderSidebar();
        }

        function renderSidebar() {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = '';

            const items = dataStore[currentTab] || [];

            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'yt-card';
                card.onclick = () => {
                    if (currentTab === 'categories' && item.subcategories) {
                        displaySubcategories(item.subcategories);
                    } else if (currentTab === 'series') {
                        loadSeriesDetails(item);
                    } else {
                        loadVideo(index, currentTab);
                    }
                };

                const title = item.title || item.name || 'Без названия';
                const thumb = item.logo || item.poster || 'assets/img/no-thumb.jpg';
                const meta = item.year ? `${item.year} • ${item.duration} мин` : (item.item_count ? `${item.item_count} шт` : '');

                card.innerHTML = `
                    <img src="${thumb}" class="yt-thumb">
                    <div class="yt-card-info">
                        <div class="yt-card-title">${title}</div>
                        <div class="yt-card-meta">${meta}</div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function displaySubcategories(subs) {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = `<button class="yt-tab" style="width:100%; margin-bottom:10px;" onclick="renderSidebar()">← Назад к категориям</button>`;
            subs.forEach(sub => {
                const card = document.createElement('div');
                card.className = 'yt-card';
                card.onclick = () => { /* Load filter by category */ };
                card.innerHTML = `
                    <div class="yt-card-info">
                        <div class="yt-card-title">${sub.name}</div>
                        <div class="yt-card-meta">${sub.count || 0} видео</div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        async function loadSeriesDetails(series) {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = `<button class="yt-tab" style="width:100%; margin-bottom:10px;" onclick="renderSidebar()">← Назад к сериалам</button>`;

            try {
                const res = await fetch(`ant-api.php?action=series&id=${series.id}`);
                const details = await res.json();
                const episodes = details.episodes || [];

                episodes.forEach((ep, idx) => {
                    const card = document.createElement('div');
                    card.className = 'yt-card';
                    card.onclick = () => {
                        player.loadSource(ep.streamUrl);
                        ui.setTitle(`${series.title} - S${ep.season}E${ep.episode}`);
                    };
                    card.innerHTML = `
                        <div class="yt-card-info">
                            <div class="yt-card-title">${ep.episode}. ${ep.title || 'Серия ' + ep.episode}</div>
                            <div class="yt-card-meta">Сезон ${ep.season}</div>
                        </div>
                    `;
                    list.appendChild(card);
                });
            } catch (e) {
                console.error('Ошибка загрузки серий:', e);
            }
        }

        async function loadVideo(index, tab) {
            const item = dataStore[tab][index];
            if (!item) return;

            // Реклама перед видео
            if (dataStore.ads.length > 0) {
                await playAd(dataStore.ads[0]);
            }

            // Загрузка видео
            const streamUrl = item.streamUrl || item.url;
            player.loadSource(streamUrl);
            ui.setTitle(item.title || item.name);

            // Обновление инфо
            document.getElementById('player-title').innerText = item.title || item.name;
            document.getElementById('player-views').innerText = item.rating ? `⭐ ${item.rating}` : 'Рейтинг N/A';
            document.getElementById('player-date').innerText = item.year || '';
            document.getElementById('player-desc').innerText = item.description || item.desc || 'Нет описания';

            // Загрузка актеров
            loadActors(item.id);
        }

        async function playAd(ad) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('ad-overlay');
                const adVideo = document.getElementById('adVideo');
                const timerSpan = document.getElementById('ad-time');

                overlay.style.display = 'flex';
                adVideo.src = ad.url || ad.streamUrl || 'https://www.w3schools.com/html/mov_bbb.mp4';
                adVideo.play();

                let timeLeft = 5; // Минимум 5 сек
                const timer = setInterval(() => {
                    timeLeft--;
                    timerSpan.innerText = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        overlay.style.display = 'none';
                        adVideo.pause();
                        resolve();
                    }
                }, 1000);

                adVideo.onended = () => {
                    clearInterval(timer);
                    overlay.style.display = 'none';
                    resolve();
                };
            });
        }

        async function loadActors(id) {
            if (!id) return;
            try {
                const res = await fetch(`ant-api.php?action=actors&id=${id}`);
                const actors = await res.json();

                const section = document.getElementById('actors-section');
                const list = document.getElementById('actors-list');

                if (actors && actors.length > 0) {
                    section.style.display = 'block';
                    list.innerHTML = '';
                    actors.forEach(a => {
                        const actorDiv = document.createElement('div');
                        actorDiv.style.textAlign = 'center';
                        actorDiv.style.minWidth = '80px';
                        actorDiv.innerHTML = `
                            <img src="${a.photo || 'assets/img/no-actor.jpg'}" style="width:60px; height:60px; border-radius:50%; object-fit:cover;">
                            <div style="font-size:12px; margin-top:5px;">${a.name}</div>
                            <div style="font-size:10px; color:#aaa;">${a.role || ''}</div>
                        `;
                        list.appendChild(actorDiv);
                    });
                } else {
                    section.style.display = 'none';
                }
            } catch (e) {
                console.error('Ошибка загрузки актеров:', e);
            }
        }
    </script>
</body>

</html>