<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLS API Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }
        h1 {
            color: #4ec9b0;
        }
        .test-section {
            background: #252526;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #1177bb;
        }
        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border-left: 3px solid #4ec9b0;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
    </style>
</head>
<body>
    <h1>üß™ HLS Structure API Tester</h1>
    
    <div class="test-section">
        <h2>Test 1: API Structure Parser</h2>
        <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã HLS –∏–∑ file-browser</p>
        <button onclick="testAPI()">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç API</button>
        <pre id="api-result">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</pre>
    </div>

    <div class="test-section">
        <h2>Test 2: HLS Player Functions</h2>
        <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ –ø–ª–µ–µ—Ä–µ</p>
        <button onclick="testPlayer()">‚ñ∂ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–µ–µ—Ä</button>
        <pre id="player-result">–û—Ç–∫—Ä–æ–π—Ç–µ –ø–ª–µ–µ—Ä –≤ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–µ...</pre>
    </div>

    <div class="test-section">
        <h2>Test 3: Manual Commands</h2>
        <p>–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12)</p>
        <pre>
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å HLS –æ–±—ä–µ–∫—Ç:
console.log(window.VideoPlayerAPI?.player?.hls);

// –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —É—Ä–æ–≤–Ω–∏ –∫–∞—á–µ—Å—Ç–≤–∞:
window.VideoPlayerAPI?.player?.hls?.levels.forEach((l, i) =>  {
    console.log(`${i}: ${l.height}p - ${(l.bitrate/1000).toFixed(0)} kbps`);
});

// –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞—É–¥–∏–æ-–¥–æ—Ä–æ–∂–∫–∏:
window.VideoPlayerAPI?.player?.hls?.audioTracks.forEach((t, i) => {
    console.log(`${i}: ${t.name} (${t.lang})`);
});

// –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ 1080p:
window.VideoPlayerAPI.player.hls.currentLevel = 3;

// –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞—É–¥–∏–æ:
window.VideoPlayerAPI.player.hls.audioTrack = 1;
        </pre>
    </div>

    <script>
        async function testAPI() {
            const result = document.getElementById('api-result');
            result.innerHTML—Ä—É–± = '<span class="warning">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</span>';
            
            try {
                const url = '/player/hls-structure-api.php?lun=lun1&path=Fantasticheskaya.4.pervie.shagi.2025.WEB-DL.1080p';
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    result.innerHTML = `<span class="success">‚úÖ SUCCESS!</span>\n\n` +
                        `<strong>–ü—É—Ç—å:</strong> ${data.path}\n` +
                        `<strong>LUN:</strong> ${data.lun}\n\n` +
                        `<strong>–ü—Ä–æ—Ñ–∏–ª–∏ –∫–∞—á–µ—Å—Ç–≤–∞:</strong>\n` +
                        data.profiles.map(p => `  - ${p.name} (${p.resolution}p)`).join('\n') +
                        `\n\n<strong>Master URL:</strong>\n${data.masterUrl}\n\n` +
                        `<strong>–°—É–±—Ç–∏—Ç—Ä—ã:</strong>\n` +
                        (data.subtitles.length > 0 ? 
                            data.subtitles.map(s => `  - ${s.label} (${s.lang})`).join('\n') :
                            '  –ù–µ—Ç —Å—É–±—Ç–∏—Ç—Ä–æ–≤') +
                        `\n\n<strong>–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong>\n${JSON.stringify(data, null, 2)}`;
                } else {
                    result.innerHTML = `<span class="error">‚ùå –û–®–ò–ë–ö–ê:</span>\n${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                }
            } catch (error) {
                result.innerHTML = `<span class="error">‚ùå EXCEPTION:</span>\n${error.message}\n\n${error.stack}`;
            }
        }

        function testPlayer() {
            const result = document.getElementById('player-result');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
            if (typeof window.VideoPlayerAPI === 'undefined') {
                result.innerHTML = '<span class="error">‚ùå VideoPlayerAPI –Ω–µ –Ω–∞–π–¥–µ–Ω</span>\n\n' +
                    '–û—Ç–∫—Ä–æ–π—Ç–µ –ø–ª–µ–µ—Ä –≤ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–µ:\n' +
                    'http://localhost:8000/player/';
                return;
            }

            const player = window.VideoPlayerAPI.player;
            const hls = player.hls;

            if (!hls) {
                result.innerHTML = '<span class="error">‚ùå HLS –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω</span>\n\n' +
                    '–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –≤ –ø–ª–µ–µ—Ä–µ!';
                return;
            }

            // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            let info = '<span class="success">‚úÖ –ü–ª–µ–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!</span>\n\n';
            
            // –£—Ä–æ–≤–Ω–∏ –∫–∞—á–µ—Å—Ç–≤–∞
            info += '<strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –∫–∞—á–µ—Å—Ç–≤–∞:</strong>\n';
            if (hls.levels && hls.levels.length > 0) {
                hls.levels.forEach((level, i) => {
                    const current = hls.currentLevel === i ? ' ‚Üê –¢–ï–ö–£–©–ò–ô' : '';
                    info += `  ${i}: ${level.height}p - ${(level.bitrate/1000).toFixed(0)} kbps${current}\n`;
                });
            } else {
                info += '  –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö\n';
            }

            // –ê—É–¥–∏–æ-–¥–æ—Ä–æ–∂–∫–∏
            info += '\n<strong>–ê—É–¥–∏–æ-–¥–æ—Ä–æ–∂–∫–∏:</strong>\n';
            if (hls.audioTracks && hls.audioTracks.length > 0) {
                hls.audioTracks.forEach((track, i) => {
                    const current = hls.audioTrack === i ? ' ‚Üê –ê–ö–¢–ò–í–ù–ê–Ø' : '';
                    info += `  ${i}: ${track.name} (${track.lang})${current}\n`;
                });
            } else {
                info += '  –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö\n';
            }

            // –°—É–±—Ç–∏—Ç—Ä—ã
            info += '\n<strong>–°—É–±—Ç–∏—Ç—Ä—ã:</strong>\n';
            const video = player.video;
            if (video.textTracks && video.textTracks.length > 0) {
                for (let i = 0; i < video.textTracks.length; i++) {
                    const track = video.textTracks[i];
                    const active = track.mode === 'showing' ? ' ‚Üê –ê–ö–¢–ò–í–ù–´' : '';
                    info += `  ${i}: ${track.label} (${track.language})${active}\n`;
                }
            } else {
                info += '  –ù–µ—Ç —Å—É–±—Ç–∏—Ç—Ä–æ–≤\n';
            }

            result.innerHTML = info;
        }

        // –ê–≤—Ç–æ—Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            console.log('üß™ HLS API Tester –∑–∞–≥—Ä—É–∂–µ–Ω');
            console.log('–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤');
        });
    </script>
</body>
</html>
