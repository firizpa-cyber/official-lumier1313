<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANT-TV (YouTube Style)</title>
    <link rel="stylesheet" href="assets/css/youtube-theme.css">
    <link rel="stylesheet" href="assets/css/player-modern.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .yt-tab {
            background: none;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #606060;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .yt-tab:hover {
            background: #f2f2f2;
        }

        .yt-tab.active {
            background: #000;
            color: #fff;
        }
    </style>
</head>

<body>
    <header class="yt-header">
        <div class="yt-logo-section">
            <div class="yt-burger"><span class="material-icons">menu</span></div>
            <div class="yt-logo">
                <span class="material-icons yt-logo-icon">play_circle_filled</span>
                <span>ANT-TV</span>
            </div>
        </div>
        <div class="yt-search-section">
            <div class="yt-search-box">
                <input type="text" id="stream-url" class="yt-search-input"
                    placeholder="Вставьте ссылку на поток (m3u8)...">
                <button class="yt-search-btn" onclick="loadCustomStream()">
                    <span class="material-icons">play_arrow</span>
                </button>
            </div>
        </div>
        <div class="yt-icons-section">
            <button class="yt-icon-btn"><span class="material-icons">video_call</span></button>
            <button class="yt-icon-btn"><span class="material-icons">notifications</span></button>
            <div class="yt-avatar">A</div>
        </div>
    </header>

    <div class="yt-container">
        <div class="yt-primary">
            <div class="yt-player-wrapper">
                <div class="video-container" id="video-container">
                    <video id="main-video"></video>
                    <div class="player-overlay"></div>
                    <div class="player-controls">
                        <div class="progress-container" id="progress-container">
                            <div class="progress-bg">
                                <div class="progress-filled" style="width: 0%"></div>
                                <div class="progress-handle" style="left: 0%"></div>
                            </div>
                        </div>
                        <div class="controls-row">
                            <div class="controls-left">
                                <button class="btn-icon" onclick="player.seek(player.video.currentTime - 10)">
                                    <span class="material-icons" style="font-size:24px; color:white;">replay_10</span>
                                </button>
                                <button class="btn-icon btn-play-large" id="play-btn" onclick="togglePlay()">
                                    <span class="material-icons" style="font-size:28px; color:black;">play_arrow</span>
                                </button>
                                <button class="btn-icon" onclick="player.seek(player.video.currentTime + 10)">
                                    <span class="material-icons" style="font-size:24px; color:white;">forward_10</span>
                                </button>
                                <div class="volume-container"
                                    style="display:flex; align-items:center; margin-left:8px;">
                                    <button class="btn-icon" id="mute-btn" onclick="toggleMute()">
                                        <span class="material-icons"
                                            style="font-size:24px; color:white;">volume_up</span>
                                    </button>
                                    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1"
                                        style="width:70px; height:4px; margin-left:8px; cursor:pointer; accent-color:white;">
                                </div>
                                <div class="time-display">
                                    <span class="time-current">0:00</span> / <span class="time-duration">0:00</span>
                                </div>
                            </div>
                            <div class="controls-right">
                                <button class="btn-text" data-menu="quality"><span
                                        class="material-icons">settings</span></button>
                                <button class="btn-text" data-menu="audio"><span
                                        class="material-icons">audiotrack</span></button>
                                <button class="btn-icon" onclick="toggleFullscreen()"><span
                                        class="material-icons">fullscreen</span></button>
                            </div>
                        </div>
                    </div>
                    <div class="player-menu" id="menu-quality" data-menu="quality">
                        <div class="menu-content" id="quality-list"></div>
                    </div>
                    <div class="player-menu" id="menu-audio" data-menu="audio">
                        <div class="menu-content" id="audio-list"></div>
                    </div>
                </div>
            </div>
            <div class="yt-video-title" id="video-title">Выберите видео справа...</div>
            <div class="yt-video-actions">
                <div class="yt-channel-info">
                    <div class="yt-channel-avatar"></div>
                    <div class="yt-channel-text">
                        <div class="yt-channel-name">ANT-TV Channel</div>
                        <div class="yt-sub-count">1.2M подписчиков</div>
                    </div>
                    <button class="yt-subscribe-btn">Подписаться</button>
                </div>
                <div class="yt-action-btns">
                    <button class="yt-btn-gray"><span class="material-icons">thumb_up</span> 12K</button>
                    <button class="yt-btn-gray"><span class="material-icons">share</span> Поделиться</button>
                    <button class="yt-btn-gray"><span class="material-icons">download</span> Скачать</button>
                </div>
            </div>
            <div class="yt-description-box" id="video-desc">
                <div class="yt-desc-meta">254 тыс. просмотров • 2 часа назад</div>
                <div id="desc-text">Описание видео появится здесь...</div>
            </div>
        </div>
        <div class="yt-secondary">
            <div class="yt-tabs" style="display: flex; gap: 8px; padding: 10px; border-bottom: 1px solid #e5e5e5;">
                <button class="yt-tab active" id="tab-movies" onclick="switchTab('movies')">Фильмы</button>
                <button class="yt-tab" id="tab-channels" onclick="switchTab('channels')">ТВ Каналы</button>
            </div>
            <div id="sidebar-list">
                <div style="text-align:center; padding:20px; color:#606060;">Загрузка...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="assets/js/player-core.js"></script>
    <script src="modules/audio/player-audio.js"></script>
    <script src="modules/subtitles/player-subtitles.js"></script>

    <script>
        let player = null;
        let movies = [];
        let currentTab = 'movies';
        let channelList = [];

        window.onload = async () => {
            initPlayer();
            setupUI();
            await loadAllData();
        };

        async function loadAllData() {
            await Promise.all([loadMovies(), loadChannels()]);
            renderSidebar();

            if (currentTab === 'movies' && movies.length > 0) loadVideo(0, 'movies');
            else if (currentTab === 'channels' && channelList.length > 0) loadVideo(0, 'channels');
        }

        async function loadMovies() {
            try {
                const response = await fetch('live-api.php');
                const data = await response.json();
                if (Array.isArray(data)) {
                    movies = data
                        .filter(m => m.streamUrl && m.streamUrl.trim().length > 5)
                        .map(m => ({
                            title: m.title, url: m.streamUrl, poster: m.poster || m.logo,
                            logo: m.logo, banner: m.banner || m.poster, channel: 'ANT-TV (Фильм)',
                            views: m.rating ? `⭐ ${m.rating}` : 'N/A',
                            time: m.year ? `${m.year}` : '', duration: m.duration ? `${m.duration} мин` : '',
                            desc: m.description || 'Нет описания', age: m.age || '', country: m.country || '',
                            type: 'movie'
                        }));
                }
            } catch (e) {
                console.error('❌ Ошибка загрузки фильмов:', e);
            }
        }

        async function loadChannels() {
            try {
                const response = await fetch('channels-api.php');
                const data = await response.json();
                if (Array.isArray(data)) {
                    channelList = data
                        .filter(c => c.streamUrl && c.streamUrl.trim().length > 5)
                        .map(c => ({
                            title: c.title, url: c.streamUrl, poster: c.logo,
                            logo: c.logo, banner: c.logo, channel: 'ANT-TV (ТВ)',
                            views: 'LIVE', time: '', duration: 'LIVE',
                            desc: 'Прямой эфир', age: '', country: '',
                            type: 'channel'
                        }));
                }
            } catch (e) {
                console.error('❌ Ошибка загрузки каналов:', e);
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-movies').classList.toggle('active', tab === 'movies');
            document.getElementById('tab-channels').classList.toggle('active', tab === 'channels');
            renderSidebar();
        }

        function renderSidebar() {
            const list = document.getElementById('sidebar-list');
            list.innerHTML = '';

            const dataToRender = currentTab === 'movies' ? movies : channelList;

            if (dataToRender.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:20px; color:#ff0000;">${currentTab === 'movies' ? 'Фильмы' : 'Каналы'} не найдены</div>`;
                return;
            }

            dataToRender.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'yt-video-card';
                card.onclick = () => loadVideo(index, currentTab);
                card.innerHTML = `
                    <div class="yt-card-thumb" style="background-image: url('${item.poster}')">
                         ${item.logo ? `<img src="${item.logo}" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);max-width:120px;max-height:80px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.6));z-index:2;" onerror="this.style.display='none'" alt="">` : ''}
                        <div class="yt-duration">${item.duration}</div>
                    </div>
                    <div class="yt-card-info">
                        <div class="yt-card-title">${item.title}</div>
                        <div class="yt-card-meta">${item.channel}</div>
                        <div class="yt-card-meta">${item.views}${item.time ? ' • ' + item.time : ''}</div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function loadVideo(index, type = 'movies') {
            const list = type === 'movies' ? movies : channelList;
            const item = list[index];
            if (!item || !item.url) {
                console.error('Невалидный объект:', item);
                return;
            }
            document.getElementById('video-title').textContent = item.title;
            document.querySelector('.yt-channel-name').textContent = item.channel;
            document.getElementById('desc-text').textContent = item.desc;
            document.querySelector('.yt-desc-meta').textContent = item.type === 'movie' ? `${item.views} просмотров • ${item.time}` : 'Прямой эфир';

            if (player) {
                player.loadSource(item.url, 'hls');
                player.video.addEventListener('loadeddata', function autoplay() {
                    player.play().catch(err => console.log('Автоплей заблокирован:', err));
                    player.video.removeEventListener('loadeddata', autoplay);
                }, { once: true });
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function loadCustomStream() {
            const url = document.getElementById('stream-url').value;
            if (url && player) {
                player.loadSource(url, 'hls');
                document.getElementById('video-title').textContent = "Пользовательский поток";
                document.getElementById('desc-text').textContent = url;
            }
        }

        function initPlayer() {
            if (typeof ProVideoPlayer === 'undefined') {
                console.error('ProVideoPlayer not loaded');
                return;
            }
            player = new ProVideoPlayer({ videoElement: 'main-video', container: 'video-container', autoplay: false });
            if (typeof PlayerAudio !== 'undefined') player.audio = new PlayerAudio(player);
            if (typeof PlayerSubtitles !== 'undefined') player.subtitles = new PlayerSubtitles(player);
            player.on('timeupdate', updateProgress);
            player.on('play', () => updatePlayBtn(true));
            player.on('pause', () => updatePlayBtn(false));
            player.on('manifestparsed', () => updateQualityMenu());
            player.on('audiotracksupdate', updateAudioMenu);
            player.video.addEventListener('volumechange', updateVolumeUI);
        }

        function setupUI() {
            document.querySelectorAll('.btn-text').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const menuId = 'menu-' + btn.dataset.menu;
                    toggleMenu(menuId);
                };
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.player-menu') && !e.target.closest('.btn-text')) closeAllMenus();
            });
            const pContainer = document.getElementById('progress-container');
            if (pContainer) {
                pContainer.onclick = (e) => {
                    const rect = pContainer.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    if (player && player.video.duration) player.seek(pos * player.video.duration);
                };
            }
            const vSlider = document.getElementById('volume-slider');
            if (vSlider) {
                vSlider.oninput = (e) => {
                    if (player && player.video) {
                        player.video.volume = parseFloat(e.target.value);
                        player.video.muted = false;
                    }
                };
            }
        }

        function toggleMute() {
            if (!player || !player.video) return;
            player.video.muted = !player.video.muted;
        }

        function updateVolumeUI() {
            if (!player || !player.video) return;
            const vSlider = document.getElementById('volume-slider');
            const muteBtn = document.getElementById('mute-btn');
            if (vSlider) vSlider.value = player.video.muted ? 0 : player.video.volume;
            if (muteBtn) {
                let icon = 'volume_up';
                if (player.video.muted || player.video.volume === 0) icon = 'volume_off';
                else if (player.video.volume < 0.5) icon = 'volume_down';
                muteBtn.innerHTML = `<span class="material-icons" style="font-size:24px; color:white;">${icon}</span>`;
            }
        }

        function toggleMenu(id) {
            const menu = document.getElementById(id);
            if (!menu) return;
            const isVisible = menu.classList.contains('show');
            closeAllMenus();
            if (!isVisible) menu.classList.add('show');
        }

        function closeAllMenus() {
            document.querySelectorAll('.player-menu').forEach(m => m.classList.remove('show'));
        }

        function updatePlayBtn(isPlaying) {
            const btn = document.getElementById('play-btn');
            if (btn) {
                btn.innerHTML = isPlaying ?
                    '<span class="material-icons" style="font-size:28px; color:black;">pause</span>' :
                    '<span class="material-icons" style="font-size:28px; color:black;">play_arrow</span>';
            }
        }

        function togglePlay() {
            if (player && player.video) player.video.paused ? player.play() : player.pause();
        }

        function toggleFullscreen() {
            const c = document.getElementById('video-container');
            if (c) document.fullscreenElement ? document.exitFullscreen() : c.requestFullscreen();
        }

        function updateProgress() {
            if (!player || !player.video || !player.video.duration) return;
            const pct = (player.video.currentTime / player.video.duration) * 100;
            const filled = document.querySelector('.progress-filled');
            const handle = document.querySelector('.progress-handle');
            if (filled) filled.style.width = pct + '%';
            if (handle) handle.style.left = pct + '%';
            const curr = document.querySelector('.time-current');
            const dur = document.querySelector('.time-duration');
            if (curr) curr.textContent = formatTime(player.video.currentTime);
            if (dur) dur.textContent = formatTime(player.video.duration);
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' + sec : sec}`;
        }

        function updateQualityMenu() {
            const list = document.getElementById('quality-list');
            if (!list || !player.hls) return;
            list.innerHTML = '';
            addMenuItem(list, 'Авто', true, () => { player.setAutoQuality(); });
            player.hls.levels.forEach((l, i) => {
                addMenuItem(list, `${l.height}p`, false, () => { player.setQuality(i); });
            });
        }

        function updateAudioMenu(tracks) {
            const list = document.getElementById('audio-list');
            if (!list) return;
            list.innerHTML = '';
            tracks.forEach((t, i) => {
                addMenuItem(list, t.name, i === 0, () => { player.audio.setTrack(t.id); });
            });
        }

        function addMenuItem(container, text, active, cb) {
            const div = document.createElement('div');
            div.className = `menu-item ${active ? 'active' : ''}`;
            div.innerHTML = `<span>${text}</span>`;
            div.onclick = cb;
            container.appendChild(div);
        }
    </script>
</body>

</html>