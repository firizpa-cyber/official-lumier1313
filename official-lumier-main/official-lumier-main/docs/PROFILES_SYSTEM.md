# Система управления профилями пользователей

## Обзор

Полноценная система управления профилями с возможностью:
- Создания нескольких профилей для одного номера телефона
- Редактирования данных профиля (Имя, Фамилия, Тип аккаунта)
- Переключения между профилями
- Сохранения данных в JSON-базе данных

## Архитектура

### Backend API (`server/routes/profiles.ts`)

#### Endpoints:

**GET /api/profiles/:phone**
- Получает все профили по номеру телефона
- Параметры: `phone` - номер телефона (с или без +992)
- Ответ: `{ success: true, profiles: Profile[] }`

**POST /api/profiles**
- Создает новый профиль
- Body: `{ phone, firstName, lastName, accountType }`
- Ответ: `{ success: true, profile: Profile }`

**PUT /api/profiles/:id**
- Обновляет существующий профиль
- Параметры: `id` - ID профиля
- Body: `{ firstName, lastName, accountType }`
- Ответ: `{ success: true, profile: Profile }`

**DELETE /api/profiles/:id**
- Удаляет профиль (нельзя удалить последний профиль)
- Параметры: `id` - ID профиля
- Ответ: `{ success: true, message: string }`

### Frontend (`src/pages/ProfilePage.tsx`)

#### Функциональность:

1. **Автоматическая загрузка профилей**
   - При входе на страницу загружаются все профили пользователя
   - Если профилей нет - создается первый профиль автоматически

2. **Выбор профиля**
   - Визуальный список всех профилей
   - Активный профиль выделен синим цветом с галочкой
   - Клик по профилю делает его активным и загружает данные в форму

3. **Добавление профиля**
   - Кнопка "+ Добавить аккаунт"
   - Создает новый пустой профиль
   - Автоматически делает его активным

4. **Редактирование профиля**
   - Поля: Имя, Фамилия, Номер телефона (readonly), Тип аккаунта
   - Кнопка "Сохранить изменения"
   - Анимация загрузки при сохранении
   - Toast-уведомления об успехе/ошибке

## Структура данных

### Profile Interface
```typescript
interface Profile {
  id: string;              // Уникальный ID (profile_timestamp_random)
  phone: string;           // Номер телефона без +992
  firstName: string;       // Имя
  lastName: string;        // Фамилия
  accountType: 'child' | 'adult' | 'senior';  // Тип аккаунта
  createdAt: string;       // ISO дата создания
  updatedAt: string;       // ISO дата обновления
}
```

### База данных (data/profiles.json)
```json
{
  "profiles": [
    {
      "id": "profile_1703516400000_abc123def",
      "phone": "929929292",
      "firstName": "Иван",
      "lastName": "Иванов",
      "accountType": "adult",
      "createdAt": "2025-12-24T10:00:00.000Z",
      "updatedAt": "2025-12-24T10:30:00.000Z"
    }
  ]
}
```

## Типы аккаунтов

- **child** (Детский) - для детских профилей
- **adult** (Взрослый) - стандартный взрослый профиль
- **senior** (Семейный) - семейный профиль

## Интеграция с авторизацией

После успешной авторизации в `AuthPage`:
```typescript
localStorage.setItem("auth_data", JSON.stringify({
  phone: "+992929929292",
  loginDate: "2025-12-24T10:00:00.000Z"
}));
```

Профили загружаются из этих данных автоматически.

## UI/UX Особенности

### Визуальные элементы:

1. **Карточка профиля**
   - Круглая аватарка с иконкой User
   - Имя Фамилия (или "Имя Фамилия" если пусто)
   - Форматированный номер телефона: +992 XX XXX XX XX
   - Активный профиль: синий фон, синяя аватарка, галочка

2. **Кнопка добавления**
   - Пунктирная рамка
   - Иконка Plus
   - Hover эффект

3. **Форма редактирования**
   - Темные инпуты с прозрачным фоном
   - Синий фокус
   - Label в uppercase
   - Большие поля (h-14)

4. **Анимации**
   - Спиннер загрузки при первой загрузке
   - Спиннер в кнопке при сохранении
   - Плавные переходы цветов

## Обработка ошибок

- Все API запросы обернуты в try-catch
- Toast-уведомления для всех операций
- Graceful fallback при отсутствии профилей
- Невозможно удалить последний профиль пользователя

## Безопасность

- Номер телефона readonly (нельзя изменить)
- Профили привязаны к номеру телефона
- Каждый пользователь видит только свои профили
- Валидация на backend

## Примеры использования

### Тестирование через API

```bash
# Получить профили
curl http://localhost:3001/api/profiles/+992929929292

# Создать профиль
curl -X POST http://localhost:3001/api/profiles \
  -H "Content-Type: application/json" \
  -d '{"phone":"+992929929292","firstName":"Иван","lastName":"Иванов","accountType":"adult"}'

# Обновить профиль
curl -X PUT http://localhost:3001/api/profiles/profile_xxx \
  -H "Content-Type: application/json" \
  -d '{"firstName":"Петр","lastName":"Петров","accountType":"senior"}'
```

## Будущие улучшения

- [ ] Загрузка аватара пользователя
- [ ] История изменений профиля
- [ ] Экспорт/импорт профилей
- [ ] Резервное копирование БД
- [ ] Миграция на SQLite/PostgreSQL
- [ ] Права доступа для детских профилей
- [ ] Родительский контроль
